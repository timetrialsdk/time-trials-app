<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Time Trials</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:'Orbitron',sans-serif; background:#000; color:#ffb300; overflow-x:hidden; }

/* SPEED LINES */
body::before{
  content:"";
  position:fixed;
  inset:-100% -100% -100% -100%;
  background:repeating-linear-gradient(135deg,
    rgba(255,150,0,0.32) 0px,
    rgba(255,150,0,0.32) 16px,
    transparent 16px,
    transparent 320px);
  pointer-events:none;
  z-index:1;
}

/* FLAGS */
.flag{
  position:fixed;
  width:180px;height:130px;
  background-size:36px 36px;
  background-image:
    linear-gradient(45deg,#000 25%,transparent 25%),
    linear-gradient(-45deg,#000 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#000 75%),
    linear-gradient(-45deg,transparent 75%,#000 75%);
  background-position:0 0,0 18px,18px -18px,-18px 0px;
  background-color:#fff;
  z-index:1;
}
.flag-left{top:140px;left:40px;transform:rotate(-18deg);}
.flag-right{bottom:40px;right:40px;transform:rotate(12deg);}

#home,.route-page,.popup{position:relative;z-index:2;}

button{
  padding:8px 14px;
  background:#111;
  color:#ffb300;
  border:1px solid #ffb300;
  border-radius:6px;
  cursor:pointer;
  transition:.15s;
}
button:hover{transform:scale(1.08);box-shadow:0 0 12px rgba(255,180,0,.7);}

.menu-box{
  max-width:420px;margin:20px auto;background:#111;padding:20px;border-radius:12px;
  box-shadow:0 0 25px rgba(0,0,0,.7);text-align:center;
}

.route-card{
  background:#111;padding:15px;border-radius:8px;width:260px;cursor:pointer;
  box-shadow:0 0 15px rgba(0,0,0,.6);
}

.route-page{position:fixed;inset:0;display:none;padding:30px;z-index:1000;}

.route-container{
  max-width:900px;margin:auto;background:#111;padding:25px;border-radius:12px;
  box-shadow:0 0 30px rgba(0,0,0,.7);
}

table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #333;padding:6px;text-align:center;}
th{background:#222;}
a{color:#ffb300;}

.trash{background:none;border:none;color:red;cursor:pointer;font-size:18px;}

/* POPUPS */
.popup{
  position:fixed;inset:0;display:none;background:rgba(0,0,0,.85);
  align-items:center;justify-content:center;z-index:3000;
}
.popup-box{
  background:#111;padding:20px;border-radius:12px;
  max-width:500px;width:100%;
  box-shadow:0 0 30px rgba(0,0,0,.8);
}

#snakeCanvas{background:#000;border:2px solid #ffb300;}
</style>
</head>

<body>

<div class="flag flag-left"></div>
<div class="flag flag-right"></div>

<div id="home">
  <h1 style="text-align:center;font-size:60px;">TIME TRIALS</h1>
  <div style="text-align:center;font-size:20px;">hvis ikke du ryster, var det ikke hurtigt nok</div>

  <div class="menu-box">
    <input id="newRouteName" placeholder="Navn p√• rute">
    <button onclick="addRoute()">Tilf√∏j rute</button><br><br>

    <!-- KNAPPERNE UNDER TILF√òJ RUTE -->
    <button onclick="openLeaderboard()">üèÜ Leaderboard</button>
    <button onclick="openGames()">üéÆ Games</button>
  </div>

  <h2 style="text-align:center;color:red;">RUNS</h2>
  <div id="routes" style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;"></div>
</div>

<div class="route-page" id="routePage"></div>

<!-- LEADERBOARD -->
<div class="popup" id="leaderboardPopup">
  <div class="popup-box">
    <button onclick="closeLeaderboard()">‚Üê Tilbage</button>
    <h2>üèÜ Leaderboard</h2>
    <table id="leaderboardTable"></table>
  </div>
</div>

<!-- GAMES -->
<div class="popup" id="gamesPopup">
  <div class="popup-box" style="text-align:center;">
    <button onclick="closeGames()">‚Üê Tilbage</button>
    <h2>üéÆ Snake</h2>
    <p>Tryk SPACE for at starte / pause</p>
    <canvas id="snakeCanvas" width="300" height="300"></canvas>
  </div>
</div>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain: "time-trials-b519e.firebaseapp.com",
  projectId: "time-trials-b519e",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let data={routes:{}};
let currentRoute=null;

// LIVE OPDATERING
db.collection("routes").onSnapshot(snapshot=>{
  data.routes={};
  snapshot.forEach(doc=>{
    data.routes[doc.id]=doc.data().runs||[];
  });

  render();
  if(currentRoute) openRoute(currentRoute);
});

// ================= HJ√ÜLP =================
function timeToSeconds(t){
  if(!t)return Infinity;
  const p=t.split(":");
  return parseInt(p[0])*60+parseFloat(p[1]);
}
function medal(i){return ["ü•á","ü•à","ü•â"][i];}

// ================= ROUTES =================
async function addRoute(){
  const name=newRouteName.value.trim();
  if(!name)return;
  await db.collection("routes").doc(name).set({runs:[]});
  newRouteName.value="";
}

function render(){
  const container=document.getElementById("routes");
  container.innerHTML="";

  for(const route of Object.keys(data.routes)){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    const top3=sorted.slice(0,3);

    let list="";
    top3.forEach((e,i)=>list+=`<div>${medal(i)} ${e.name} ‚Äì ${e.time}</div>`);

    const card=document.createElement("div");
    card.className="route-card";
    card.innerHTML=`<h3>${route}</h3>${list||"Ingen tider endnu"}`;
    card.onclick=()=>openRoute(route);
    container.appendChild(card);
  }
}

function openRoute(route){
  currentRoute=route;
  home.style.display="none";
  routePage.style.display="block";

  const runs=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));

  let rows="";
  runs.forEach((e,i)=>{
    rows+=`
      <tr>
        <td>${i+1}</td>
        <td>${e.name}</td>
        <td>${e.car||"-"}</td>
        <td>${e.time}</td>
        <td><button class="trash" onclick="deleteEntry('${route}',${e.id})">üóëÔ∏è</button></td>
      </tr>`;
  });

  routePage.innerHTML=`
    <div class="route-container">
      <button onclick="closeRoute()">‚Üê Tilbage</button>
      <h2>${route}</h2>

      <input id="name" placeholder="Navn">
      <input id="car" placeholder="Bil">
      <input id="time" placeholder="mm:ss">
      <button onclick="addEntry('${route}')">+ Run</button>

      <table>
        <tr><th>#</th><th>Navn</th><th>Bil</th><th>Tid</th><th></th></tr>
        ${rows}
      </table>
    </div>`;
}

function closeRoute(){
  currentRoute=null;
  routePage.style.display="none";
  home.style.display="block";
}

// ================= RUNS =================
async function addEntry(route){
  const name=document.getElementById("name").value.trim();
  const car=document.getElementById("car").value.trim();
  const time=document.getElementById("time").value.trim();
  if(!name||!time)return;

  const runs=data.routes[route];
  runs.push({id:Date.now(),name,car,time});

  openRoute(route);
  await db.collection("routes").doc(route).set({runs});
}

async function deleteEntry(route,id){
  let runs=data.routes[route].filter(r=>r.id!==id);
  data.routes[route]=runs;
  openRoute(route);
  await db.collection("routes").doc(route).set({runs});
}

// ================= LEADERBOARD =================
function openLeaderboard(){
  const stats={};

  for(const route in data.routes){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    sorted.forEach((r,i)=>{
      if(!stats[r.name]) stats[r.name]={runs:0,g:0,s:0,b:0};
      stats[r.name].runs++;
      if(i===0) stats[r.name].g++;
      if(i===1) stats[r.name].s++;
      if(i===2) stats[r.name].b++;
    });
  }

  let rows="<tr><th>Navn</th><th>Runs</th><th>Medaljer</th></tr>";
  for(const name in stats){
    const s=stats[name];
    rows+=`
      <tr>
        <td>${name}</td>
        <td>${s.runs}</td>
        <td>ü•á ${s.g} ü•à ${s.s} ü•â ${s.b}</td>
      </tr>`;
  }

  leaderboardTable.innerHTML=rows;
  leaderboardPopup.style.display="flex";
}

function closeLeaderboard(){
  leaderboardPopup.style.display="none";
}

// ================= SNAKE =================
let canvas=document.getElementById("snakeCanvas");
let ctx=canvas.getContext("2d");
let snake=[[5,5]];
let dir=[1,0];
let food=[10,10];
let playing=false;

function draw(){
  ctx.clearRect(0,0,300,300);
  ctx.fillStyle="red";
  ctx.fillRect(food[0]*15,food[1]*15,15,15);

  ctx.fillStyle="lime";
  snake.forEach(s=>ctx.fillRect(s[0]*15,s[1]*15,15,15));
}

function step(){
  if(!playing)return;

  const head=[snake[0][0]+dir[0],snake[0][1]+dir[1]];
  if(head[0]<0||head[1]<0||head[0]>19||head[1]>19){playing=false;return;}

  snake.unshift(head);

  if(head[0]==food[0]&&head[1]==food[1]){
    food=[Math.floor(Math.random()*20),Math.floor(Math.random()*20)];
  }else{
    snake.pop();
  }

  draw();
}

setInterval(step,150);

document.addEventListener("keydown",e=>{
  if(e.code==="Space") playing=!playing;
  if(e.key==="ArrowUp") dir=[0,-1];
  if(e.key==="ArrowDown") dir=[0,1];
  if(e.key==="ArrowLeft") dir=[-1,0];
  if(e.key==="ArrowRight") dir=[1,0];
});

function openGames(){gamesPopup.style.display="flex";}
function closeGames(){gamesPopup.style.display="none";}
</script>

</body>
</html>
