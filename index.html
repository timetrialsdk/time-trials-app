<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Time Trials</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:'Orbitron',sans-serif; background:#000; color:#ffb300; overflow-x:hidden; }

body::before{
  content:"";
  position:fixed;
  inset:-100% -100% -100% -100%;
  background:repeating-linear-gradient(135deg,
    rgba(255,150,0,0.32) 0px,
    rgba(255,150,0,0.32) 16px,
    transparent 16px,
    transparent 320px);
  pointer-events:none;
  z-index:1;
}

.flag{
  position:fixed;
  width:180px;height:130px;
  background-size:36px 36px;
  background-image:
    linear-gradient(45deg,#000 25%,transparent 25%),
    linear-gradient(-45deg,#000 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#000 75%),
    linear-gradient(-45deg,transparent 75%,#000 75%);
  background-position:0 0,0 18px,18px -18px,-18px 0px;
  background-color:#fff;
  z-index:1;
}
.flag-left{top:140px;left:40px;transform:rotate(-18deg);}
.flag-right{bottom:40px;right:40px;transform:rotate(12deg);}

#home,.route-page{position:relative;z-index:2;}

button{
  padding:8px 14px;
  background:#111;
  color:#ffb300;
  border:1px solid #ffb300;
  border-radius:6px;
  cursor:pointer;
  transition:.15s;
}
button:hover{transform:scale(1.08);box-shadow:0 0 12px rgba(255,180,0,.7);}

.menu-box{
  max-width:420px;margin:20px auto;background:#111;padding:20px;border-radius:12px;
  box-shadow:0 0 25px rgba(0,0,0,.7);text-align:center;
}

.route-card{
  background:#111;padding:15px;border-radius:8px;width:260px;cursor:pointer;
  box-shadow:0 0 15px rgba(0,0,0,.6);
}

.route-page{position:fixed;inset:0;display:none;padding:30px;z-index:1000;}

.route-container{
  max-width:900px;margin:auto;background:#111;padding:25px;border-radius:12px;
  box-shadow:0 0 30px rgba(0,0,0,.7);
}

table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #333;padding:6px;text-align:center;}
th{background:#222;}
a{color:#ffb300;}

.trash{background:none;border:none;color:red;cursor:pointer;font-size:18px;}
</style>
</head>

<body>

<div class="flag flag-left"></div>
<div class="flag flag-right"></div>

<div id="home">
  <h1 style="text-align:center;font-size:60px;">TIME TRIALS</h1>
  <div style="text-align:center;font-size:20px;">hvis ikke du ryster, var det ikke hurtigt nok</div>

  <div class="menu-box">
    <input id="newRouteName" placeholder="Navn p√• rute">
    <button onclick="addRoute()">Tilf√∏j rute</button>
  </div>

  <h2 style="text-align:center;color:red;">RUNS</h2>
  <div id="routes" style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;"></div>
</div>

<div class="route-page" id="routePage"></div>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain: "time-trials-b519e.firebaseapp.com",
  projectId: "time-trials-b519e",
  storageBucket: "time-trials-b519e.firebasestorage.app",
  messagingSenderId: "491396428595",
  appId: "1:491396428595:web:627bc61e5cd1b9475fc446"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let data={routes:{}};
let currentRoute=null;

// LIVE OPDATERING FRA FIREBASE
db.collection("routes").onSnapshot(snapshot=>{
  data.routes={};
  snapshot.forEach(doc=>{
    data.routes[doc.id]=doc.data().runs||[];
  });

  render();

  if(currentRoute){
    openRoute(currentRoute);
  }
});

// ================= HJ√ÜLP =================
function timeToSeconds(t){
  if(!t)return Infinity;
  const p=t.split(":");
  return parseInt(p[0])*60+parseFloat(p[1]);
}
function medal(i){return ["ü•á","ü•à","ü•â"][i]||i+1;}

// ================= ROUTES =================
async function addRoute(){
  const name=newRouteName.value.trim();
  if(!name)return;
  await db.collection("routes").doc(name).set({runs:[]});
  newRouteName.value="";
}

function render(){
  const container=document.getElementById("routes");
  container.innerHTML="";

  for(const route of Object.keys(data.routes)){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    const top3=sorted.slice(0,3);

    let list="";
    top3.forEach((e,i)=>list+=`<div>${medal(i)} ${e.name} ‚Äì ${e.time}</div>`);

    const card=document.createElement("div");
    card.className="route-card";
    card.innerHTML=`<h3>${route}</h3>${list||"Ingen tider endnu"}`;
    card.onclick=()=>openRoute(route);
    container.appendChild(card);
  }
}

function openRoute(route){
  currentRoute=route;

  home.style.display="none";
  const page=routePage;
  page.style.display="block";

  const runs=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));

  let rows="";
  runs.forEach((e,i)=>{
    rows+=`
      <tr>
        <td>${i+1}</td>
        <td>${e.name}</td>
        <td>${e.car||"-"}</td>
        <td>${e.time}</td>
        <td>${e.video?`<a href="${e.video}" target="_blank">Video</a>`:"-"}</td>
        <td><button class="trash" onclick="deleteEntry('${route}',${e.id})">üóëÔ∏è</button></td>
      </tr>`;
  });

  page.innerHTML=`
    <div class="route-container">
      <button onclick="closeRoute()">‚Üê Tilbage</button>
      <button class="trash" onclick="deleteRoute('${route}')">üóëÔ∏è</button>
      <h2>${route}</h2>

      <input id="name" placeholder="Navn">
      <input id="car" placeholder="Bil">
      <input id="time" placeholder="mm:ss">
      <input id="video" placeholder="Video link">
      <button onclick="addEntry('${route}')">+ Run</button>

      <table>
        <tr><th>#</th><th>Navn</th><th>Bil</th><th>Tid</th><th>Video</th><th></th></tr>
        ${rows}
      </table>
    </div>`;
}

function closeRoute(){
  currentRoute=null;
  routePage.style.display="none";
  home.style.display="block";
}

// ================= RUNS =================
async function addEntry(route){
  const name  = document.getElementById("name").value.trim();
  const car   = document.getElementById("car").value.trim();
  const time  = document.getElementById("time").value.trim();
  const video = document.getElementById("video").value.trim();

  if(!name || !time){
    alert("Navn og tid skal udfyldes");
    return;
  }

  const runs = data.routes[route];

  const newRun = { 
    id: Date.now(),
    name, 
    car, 
    time, 
    video 
  };

  // üî• OPDAT√âR UI MED DET SAMME
  runs.push(newRun);
  openRoute(route);

  // send til Firebase bagefter
  await db.collection("routes").doc(route).set({ runs });

  document.getElementById("name").value="";
  document.getElementById("car").value="";
  document.getElementById("time").value="";
  document.getElementById("video").value="";
}

async function deleteEntry(route,id){
  let runs = data.routes[route];

  runs = runs.filter(r => r.id !== id);
  data.routes[route]=runs;

  // üî• OPDAT√âR UI MED DET SAMME
  openRoute(route);

  await db.collection("routes").doc(route).set({ runs });
}

async function deleteRoute(route){
  await db.collection("routes").doc(route).delete();
  closeRoute();
}
</script>

</body>
</html>
