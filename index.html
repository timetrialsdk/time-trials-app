<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Time Trials</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:'Orbitron',sans-serif; background:#000; color:#ffb300; overflow-x:hidden; }
button{padding:8px 14px;background:#111;color:#ffb300;border:1px solid #ffb300;border-radius:6px;cursor:pointer;}
button:hover{transform:scale(1.08);box-shadow:0 0 12px rgba(255,180,0,.7);}

.menu-box{max-width:420px;margin:20px auto;background:#111;padding:20px;border-radius:12px;text-align:center;}
.route-card{background:#111;padding:15px;border-radius:8px;width:260px;cursor:pointer;}
.route-page{position:fixed;inset:0;display:none;padding:30px;z-index:1000;background:#000;}
.route-container{max-width:900px;margin:auto;background:#111;padding:25px;border-radius:12px;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #333;padding:6px;text-align:center;}
.trash{background:none;border:none;color:red;font-size:18px;cursor:pointer;}

.popup{
  position:fixed;inset:0;display:none;background:rgba(0,0,0,.8);z-index:2000;
  align-items:center;justify-content:center;
}
.popup-box{
  background:#111;padding:20px;border-radius:12px;max-width:500px;width:100%;
}
#snakeCanvas{background:#000;border:2px solid #ffb300;}
</style>
</head>

<body>

<div id="home">
  <h1 style="text-align:center;font-size:60px;">TIME TRIALS</h1>

  <div class="menu-box">
    <input id="newRouteName" placeholder="Navn pÃ¥ rute">
    <button onclick="addRoute()">TilfÃ¸j rute</button><br><br>

    <!-- KNAPPERNE ER TILBAGE HER ğŸ”¥ -->
    <button onclick="openLeaderboard()">ğŸ† Leaderboard</button>
    <button onclick="openGames()">ğŸ® Games</button>
  </div>

  <h2 style="text-align:center;color:red;">RUNS</h2>
  <div id="routes" style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;"></div>
</div>

<div class="route-page" id="routePage"></div>

<!-- LEADERBOARD POPUP -->
<div class="popup" id="leaderboardPopup">
  <div class="popup-box">
    <button onclick="closeLeaderboard()">â† Tilbage</button>
    <h2>ğŸ† Leaderboard</h2>
    <table id="leaderboardTable"></table>
  </div>
</div>

<!-- GAMES POPUP -->
<div class="popup" id="gamesPopup">
  <div class="popup-box" style="text-align:center;">
    <button onclick="closeGames()">â† Tilbage</button>
    <h2>ğŸ® Snake</h2>
    <p>Tryk SPACE for at starte / pause</p>
    <canvas id="snakeCanvas" width="300" height="300"></canvas>
  </div>
</div>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain: "time-trials-b519e.firebaseapp.com",
  projectId: "time-trials-b519e",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let data={routes:{}};
let currentRoute=null;

db.collection("routes").onSnapshot(snapshot=>{
  data.routes={};
  snapshot.forEach(doc=>{
    data.routes[doc.id]=doc.data().runs||[];
  });
  render();
  if(currentRoute) openRoute(currentRoute);
});

// ================= HJÃ†LP =================
function timeToSeconds(t){
  if(!t)return Infinity;
  const p=t.split(":");
  return parseInt(p[0])*60+parseFloat(p[1]);
}
function medal(i){return ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i];}

// ================= ROUTES =================
async function addRoute(){
  const name=newRouteName.value.trim();
  if(!name)return;
  await db.collection("routes").doc(name).set({runs:[]});
  newRouteName.value="";
}

function render(){
  const container=document.getElementById("routes");
  container.innerHTML="";

  for(const route of Object.keys(data.routes)){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    const top3=sorted.slice(0,3);

    let list="";
    top3.forEach((e,i)=>list+=`<div>${medal(i)} ${e.name} â€“ ${e.time}</div>`);

    const card=document.createElement("div");
    card.className="route-card";
    card.innerHTML=`<h3>${route}</h3>${list||"Ingen tider endnu"}`;
    card.onclick=()=>openRoute(route);
    container.appendChild(card);
  }
}

function openRoute(route){
  currentRoute=route;
  home.style.display="none";
  routePage.style.display="block";

  const runs=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));

  let rows="";
  runs.forEach((e,i)=>{
    rows+=`
      <tr>
        <td>${i+1}</td>
        <td>${e.name}</td>
        <td>${e.car||"-"}</td>
        <td>${e.time}</td>
        <td><button class="trash" onclick="deleteEntry('${route}',${e.id})">ğŸ—‘ï¸</button></td>
      </tr>`;
  });

  routePage.innerHTML=`
    <div class="route-container">
      <button onclick="closeRoute()">â† Tilbage</button>
      <h2>${route}</h2>

      <input id="name" placeholder="Navn">
      <input id="car" placeholder="Bil">
      <input id="time" placeholder="mm:ss">
      <button onclick="addEntry('${route}')">+ Run</button>

      <table>
        <tr><th>#</th><th>Navn</th><th>Bil</th><th>Tid</th><th></th></tr>
        ${rows}
      </table>
    </div>`;
}

function closeRoute(){
  currentRoute=null;
  routePage.style.display="none";
  home.style.display="block";
}

// ================= RUNS =================
async function addEntry(route){
  const name=document.getElementById("name").value.trim();
  const car=document.getElementById("car").value.trim();
  const time=document.getElementById("time").value.trim();
  if(!name||!time)return;

  const runs=data.routes[route];
  runs.push({id:Date.now(),name,car,time});

  openRoute(route);
  await db.collection("routes").doc(route).set({runs});
}

async function deleteEntry(route,id){
  let runs=data.routes[route].filter(r=>r.id!==id);
  data.routes[route]=runs;
  openRoute(route);
  await db.collection("routes").doc(route).set({runs});
}

// ================= LEADERBOARD =================
function openLeaderboard(){
  const stats={};

  for(const route in data.routes){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    sorted.forEach((r,i)=>{
      if(!stats[r.name]) stats[r.name]={runs:0,g:0,s:0,b:0};
      stats[r.name].runs++;
      if(i===0) stats[r.name].g++;
      if(i===1) stats[r.name].s++;
      if(i===2) stats[r.name].b++;
    });
  }

  let rows="<tr><th>Navn</th><th>Runs</th><th>Medaljer</th></tr>";
  for(const name in stats){
    const s=stats[name];
