<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Time Trials</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:'Orbitron',sans-serif; background:#000; color:#ffb300; overflow-x:hidden; }

/* SPEED LINES */
body::before{
  content:"";
  position:fixed;
  inset:-100% -100% -100% -100%;
  background:repeating-linear-gradient(135deg,
    rgba(255,150,0,0.32) 0px,
    rgba(255,150,0,0.32) 16px,
    transparent 16px,
    transparent 320px);
  pointer-events:none;
  z-index:4000;
}

/* FLAGS */
.flag{
  position:fixed;
  width:180px;height:130px;
  background-size:36px 36px;
  background-image:
    linear-gradient(45deg,#000 25%,transparent 25%),
    linear-gradient(-45deg,#000 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#000 75%),
    linear-gradient(-45deg,transparent 75%,#000 75%);
  background-position:0 0,0 18px,18px -18px,-18px 0px;
  background-color:#fff;
  z-index:4001;
}
.flag-left{top:140px;left:40px;transform:rotate(-18deg);}
.flag-right{bottom:40px;right:40px;transform:rotate(12deg);}

#home,.route-page,.popup,.lock{position:relative;z-index:2;}

button{
  padding:8px 14px;
  background:#111;
  color:#ffb300;
  border:1px solid #ffb300;
  border-radius:6px;
  cursor:pointer;
  transition:.15s;
}
button:hover{transform:scale(1.08);box-shadow:0 0 12px rgba(255,180,0,.7);}

.menu-box{
  max-width:420px;margin:20px auto;background:#111;padding:20px;border-radius:12px;
  box-shadow:0 0 25px rgba(0,0,0,.7);text-align:center;
}

.route-card{
  background:#111;padding:15px;border-radius:8px;width:260px;cursor:pointer;
  box-shadow:0 0 15px rgba(0,0,0,.6);
}

.route-page{position:fixed;inset:0;display:none;padding:30px;z-index:1000;}

.route-container{
  max-width:900px;margin:auto;background:#111;padding:25px;border-radius:12px;
  box-shadow:0 0 30px rgba(0,0,0,.7);
}

table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #333;padding:6px;text-align:center;}
th{background:#222;}
a{color:#ffb300;}

.trash{background:none;border:none;color:red;cursor:pointer;font-size:18px;}

.popup,.lock{
  position:fixed;inset:0;display:none;background:rgba(0,0,0,0.85);
  align-items:center;justify-content:center;z-index:5000;
}
.popup-box,.lock-box{
  background:rgba(0,0,0,0.9);
  padding:40px;border-radius:12px;
  max-width:600px;width:100%;text-align:center;
  box-shadow:0 0 30px rgba(0,0,0,.8);
}

.lock{background:#000;}
.lock-box{background:#000;}
.lock-text{
  font-family:'Orbitron',sans-serif;
  color:#ffb300;
  font-size:22px;
  margin-bottom:25px;
}

#snakeCanvas{background:#000;border:2px solid #ffb300;}
</style>
</head>

<body>

<!-- üîí L√ÖSESK√ÜRM -->
<div class="lock" id="lockScreen">
  <div class="lock-box">
    <div class="lock-text">alle kan k√∏re bilen men ikke alle har rettet</div>
    <input id="siteCode" type="password" placeholder="Kode"
      style="padding:12px;width:80%;font-size:18px;
      background:#000;color:#ffb300;border:1px solid #ffb300;
      font-family:'Orbitron',sans-serif;text-align:center;">
    <br><br>
    <button onclick="checkSiteCode()">OK</button>
  </div>
</div>

<div class="flag flag-left"></div>
<div class="flag flag-right"></div>

<div id="home">
  <h1 style="text-align:center;font-size:60px;">TIME TRIALS</h1>
  <div style="text-align:center;font-size:20px;">hvis ikke du ryster, var det ikke hurtigt nok</div>

  <div class="menu-box">
    <input id="newRouteName" placeholder="Navn p√• rute">
    <button onclick="addRoute()">Tilf√∏j rute</button><br><br>

    <button onclick="openLeaderboard()">üèÜ Leaderboard</button>
    <button onclick="openGames()">üéÆ Games</button>
  </div>

  <h2 style="text-align:center;color:red;">RUNS</h2>
  <div id="routes" style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;"></div>
</div>

<div class="route-page" id="routePage"></div>

<!-- LEADERBOARD -->
<div class="popup" id="leaderboardPopup">
  <div class="popup-box">
    <button onclick="closeLeaderboard()">‚Üê Tilbage</button>
    <h2>üèÜ Leaderboard</h2>
    <table id="leaderboardTable"></table>
  </div>
</div>

<!-- GAMES -->
<div class="popup" id="gamesPopup">
  <div class="popup-box" style="text-align:center;">
    <button onclick="closeGames()">‚Üê Tilbage</button>
    <h2>üéÆ Snake</h2>
    <p>Tryk SPACE for at starte / pause</p>
    <canvas id="snakeCanvas" width="300" height="300"></canvas>
  </div>
</div>

<script>
// üîí KODE TIL AT KOMME IND
const SITE_CODE = "AK47-DRIFT-TUNE";
lockScreen.style.display = "flex";

function checkSiteCode(){
  const input = document.getElementById("siteCode").value;
  if(input === SITE_CODE){
    lockScreen.style.display = "none";
  }else{
    alert("Forkert kode");
  }
}

// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain: "time-trials-b519e.firebaseapp.com",
  projectId: "time-trials-b519e",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let data={routes:{}};
let currentRoute=null;

db.collection("routes").onSnapshot(snapshot=>{
  data.routes={};
  snapshot.forEach(doc=>{
    data.routes[doc.id]=doc.data().runs||[];
  });
  render();
  if(currentRoute) openRoute(currentRoute);
});

// ================= HJ√ÜLP =================
function timeToSeconds(t){
  if(!t)return Infinity;
  const p=t.split(":");
  return parseInt(p[0])*60+parseFloat(p[1]);
}
function medal(i){return ["ü•á","ü•à","ü•â"][i];}

// ================= BILLEDE H√ÖNDTERING =================
let selectedImage = null;

document.addEventListener("change", e => {
  if (e.target.id === "imageInput") {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      selectedImage = reader.result;
      const img = document.getElementById("imagePreview");
      img.src = selectedImage;
      img.style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

// ================= ROUTES =================
async function addRoute(){
  const name=newRouteName.value.trim();
  if(!name)return;
  await db.collection("routes").doc(name).set({runs:[]});
  newRouteName.value="";
}

function render(){
  const container=document.getElementById("routes");
  container.innerHTML="";

  for(const route of Object.keys(data.routes)){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    const top3=sorted.slice(0,3);

    let list="";
    top3.forEach((e,i)=>list+=`<div>${medal(i)} ${e.name} ‚Äì ${e.time}</div>`);

    const card=document.createElement("div");
    card.className="route-card";
    card.innerHTML=`<h3>${route}</h3>${list||"Ingen tider endnu"}`;
    card.onclick=()=>openRoute(route);
    container.appendChild(card);
  }
}

function openRoute(route){
  currentRoute=route;
  home.style.display="none";
  routePage.style.display="block";

  const runs=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));

  let rows="";
  runs.forEach((e,i)=>{
    rows+=`
      <tr>
        <td>${i+1}</td>
        <td>${e.name}</td>
        <td>${e.car||"-"}</td>
        <td>${e.time}</td>
        <td>
          ${e.video?`<a href="${e.video}" target="_blank">Video</a>`:"-"}
          <br>
          ${e.image?`<img src="${e.image}" style="max-width:80px;max-height:60px;margin-top:5px;border:1px solid #ffb300;cursor:pointer;" onclick="openImage('${e.image}')">`:""}
        </td>
        <td><button class="trash" onclick="deleteEntry('${route}',${e.id})">üóëÔ∏è</button></td>
      </tr>`;
  });

  routePage.innerHTML=`
    <div class="route-container">
      <button onclick="closeRoute()">‚Üê Tilbage</button>
      <button class="trash" style="float:right;" onclick="deleteRoute('${route}')">üóëÔ∏è</button>

      <h2>${route}</h2>

      <input id="name" placeholder="Navn">
      <input id="car" placeholder="Bil">
      <input id="time" placeholder="mm:ss">
      <input id="video" placeholder="Video link"><br><br>

      <input id="imageInput" type="file" accept="image/*">
      <br>
      <img id="imagePreview" style="max-width:200px;max-height:150px;margin-top:10px;display:none;border:1px solid #ffb300;">
      <br><br>

      <button onclick="addEntry('${route}')">+ Run</button>

      <table>
        <tr><th>#</th><th>Navn</th><th>Bil</th><th>Tid</th><th>Video / Billede</th><th></th></tr>
        ${rows}
      </table>
    </div>`;
}

function closeRoute(){
  currentRoute=null;
  routePage.style.display="none";
  home.style.display="block";
}

// üóëÔ∏è SLET HELE RUTEN
async function deleteRoute(route){
  if(!confirm("Er du sikker p√• at du vil slette hele ruten?")) return;

  await db.collection("routes").doc(route).delete();

  currentRoute=null;
  routePage.style.display="none";
  home.style.display="block";
}

// ================= RUNS =================
async function addEntry(route){
  const name=document.getElementById("name").value.trim();
  const car=document.getElementById("car").value.trim();
  const time=document.getElementById("time").value.trim();
  const video=document.getElementById("video").value.trim();
  if(!name||!time)return;

  const runs=data.routes[route];

  runs.push({
    id:Date.now(),
    name,
    car,
    time,
    video,
    image: selectedImage || null
  });

  selectedImage = null;

  openRoute(route);
  await db.collection("routes").doc(route).set({runs});
}

async function deleteEntry(route,id){
  let runs=data.routes[route].filter(r=>r.id!==id);
  data.routes[route]=runs;
  openRoute(route);
  await db.collection("routes").doc(route).set({runs});
}

// ================= LEADERBOARD =================
function openLeaderboard(){
  const stats={};

  for(const route in data.routes){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    const top3=sorted.slice(0,3);

    sorted.forEach(r=>{
      const key=r.name.toLowerCase();
      if(!stats[key]) stats[key]={name:r.name,runs:0,g:0,s:0,b:0};
      stats[key].runs++;
    });

    top3.forEach((r,i)=>{
      const key=r.name.toLowerCase();
      if(i===0) stats[key].g++;
      if(i===1) stats[key].s++;
      if(i===2) stats[key].b++;
    });
  }

  let rows="<tr><th>Navn</th><th>Runs</th><th>Medaljer</th></tr>";
  for(const key in stats){
    const s=stats[key];
    rows+=`
      <tr>
        <td>${s.name}</td>
        <td>${s.runs}</td>
        <td>ü•á ${s.g} ü•à ${s.s} ü•â ${s.b}</td>
      </tr>`;
  }

  leaderboardTable.innerHTML=rows;
  leaderboardPopup.style.display="flex";
}

function closeLeaderboard(){
  leaderboardPopup.style.display="none";
}

// ================= BILLEDE POPUP =================
function openImage(src){
  const popup=document.createElement("div");
  popup.style.position="fixed";
  popup.style.inset="0";
  popup.style.background="rgba(0,0,0,0.9)";
  popup.style.display="flex";
  popup.style.alignItems="center";
  popup.style.justifyContent="center";
  popup.style.zIndex="6000";

  popup.innerHTML=`
    <div style="position:relative;">
      <img src="${src}" style="max-width:90vw;max-height:90vh;border:2px solid #ffb300;">
      <button style="position:absolute;top:-10px;right:-10px;" onclick="this.parentElement.parentElement.remove()">X</button>
    </div>
  `;

  document.body.appendChild(popup);
}

// ================= SNAKE =================
let canvas=document.getElementById("snakeCanvas");
let ctx=canvas.getContext("2d");

let snake, dir, food, playing=false, gameOver=false;

function resetSnake(){
  snake=[[5,5]];
  dir=[1,0];
  food=[Math.floor(Math.random()*20),Math.floor(Math.random()*20)];
  draw();
}
resetSnake();

function draw(){
  ctx.clearRect(0,0,300,300);
  ctx.fillStyle="red";
  ctx.fillRect(food[0]*15,food[1]*15,15,15);
  ctx.fillStyle="lime";
  snake.forEach(s=>ctx.fillRect(s[0]*15,s[1]*15,15,15));
}

function step(){
  if(!playing)return;

  const head=[snake[0][0]+dir[0],snake[0][1]+dir[1]];

  if(head[0]<0||head[1]<0||head[0]>19||head[1]>19 ||
     snake.some(s=>s[0]===head[0]&&s[1]===head[1])){
    playing=false;
    gameOver=true;
    resetSnake();
    return;
  }

  snake.unshift(head);

  if(head[0]==food[0]&&head[1]==food[1]){
    food=[Math.floor(Math.random()*20),Math.floor(Math.random()*20)];
  }else{
    snake.pop();
  }

  draw();
}

setInterval(step,150);

document.addEventListener("keydown",e=>{
  if(e.code==="Space"){
    if(!playing){
      if(gameOver){
        resetSnake();
        gameOver=false;
      }
      playing=true;
    }else{
      playing=false;
    }
  }

  if(e.key==="ArrowUp") dir=[0,-1];
  if(e.key==="ArrowDown") dir=[0,1];
  if(e.key==="ArrowLeft") dir=[-1,0];
  if(e.key==="ArrowRight") dir=[1,0];
});

function openGames(){gamesPopup.style.display="flex";}
function closeGames(){gamesPopup.style.display="none";}
</script>

</body>
</html>
