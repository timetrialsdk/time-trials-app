<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIME TRIALS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#eee}
button{cursor:pointer}
#loginScreen{position:fixed;inset:0;background:black;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000}
#loginScreen h1{color:gold;text-align:center;margin-bottom:30px}
#loginScreen input,#loginScreen button{width:260px;padding:12px;margin:6px;border-radius:6px;border:none}

#app{display:none}
header{text-align:center;padding:20px;background:#000}
.title{font-size:38px;color:gold}
.subtitle{color:#ccc}

.container{padding:15px}
.route{background:#1c1c1c;padding:12px;border-radius:8px;margin-bottom:12px}
.route-meta{font-size:13px;color:#aaa}
.medal{margin-right:6px}

#map{height:350px;border-radius:8px;margin:10px 0}
.hidden{display:none}

input{width:100%;padding:8px;margin-bottom:6px;border-radius:5px;border:1px solid #333;background:#222;color:#eee}
.timeRow{background:#222;padding:6px;margin-top:6px;border-radius:4px}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <h1>alle kan kÃ¸re bil,<br>men det er ikke alle der har rettet</h1>
  <input id="pw" type="password" placeholder="Kodeord">
  <button onclick="doLogin()">Log ind</button>
</div>

<!-- APP -->
<div id="app">
<header>
  <div class="title">TIME TRIALS</div>
  <div class="subtitle"><em>hvis ikke du ryster, var det ikke hurtigt nok</em></div>
</header>

<div class="container" id="routeList"></div>

<div class="container hidden" id="routePage">
  <button onclick="goBack()">â¬… Tilbage</button>
  <input id="routeName">
  <div id="routeLength" class="route-meta">ğŸ“ LÃ¦ngde: â€“</div>

  <div id="map"></div>
  <button onclick="saveRoute()">ğŸ’¾ Gem rute</button>

  <h3>Tider</h3>
  <div id="times"></div>

  <input id="nameInput" placeholder="Navn">
  <input id="timeInput" placeholder="Tid (mm:ss)">
  <input id="videoInput" placeholder="Video-link">
  <button onclick="addRun()">TilfÃ¸j run</button>
</div>
</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey:"AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain:"time-trials-b519e.firebaseapp.com",
  projectId:"time-trials-b519e"
});
const db = firebase.firestore();

/* ===== LOGIN ===== */
function doLogin(){
  if(pw.value === "AK47-DRIFT-TUNE"){
    loginScreen.style.display="none";
    app.style.display="block";
  }
}

/* ===== DATA ===== */
let routes=[], current=null, map=null, router=null, localPoints=[];

db.collection("routes").onSnapshot(s=>{
  routes=[];
  s.forEach(d=>routes.push({id:d.id,...d.data()}));
  renderRoutes();
});

function toSec(t){
  const [m,s]=t.split(":").map(Number);
  return m*60+s;
}

/* ===== FORSIDE ===== */
function renderRoutes(){
  routeList.innerHTML='<button onclick="addRoute()">â• TilfÃ¸j rute</button>';
  routes.forEach(r=>{
    const top3=[...(r.times||[])].sort((a,b)=>toSec(a.time)-toSec(b.time)).slice(0,3);
    const d=document.createElement("div");
    d.className="route";
    d.innerHTML=`
      <b>${r.name}</b>
      <div class="route-meta">ğŸ“ ${(r.distance/1000||0).toFixed(2)} km</div>
      ${top3.map((t,i)=>`
        <div><span class="medal">${["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]}</span>${t.name} â€“ ${t.time}</div>
      `).join("")}
      <button onclick="openRoute('${r.id}')">Ã…bn</button>
    `;
    routeList.appendChild(d);
  });
}

function addRoute(){
  db.collection("routes").add({
    name:"Ny rute",
    points:[],
    times:[],
    distance:0,
    mapCenter:null,
    mapZoom:null
  });
}

/* ===== RUTE ===== */
function openRoute(id){
  current = routes.find(r=>r.id===id);
  routeList.classList.add("hidden");
  routePage.classList.remove("hidden");

  routeName.value=current.name;
  routeName.oninput=()=>db.collection("routes").doc(id).update({name:routeName.value});

  renderTimes();
  initMap();
}

function goBack(){
  routePage.classList.add("hidden");
  routeList.classList.remove("hidden");
}

/* ===== MAP ===== */
function initMap(){
  if(map) map.remove();

  const center = current.mapCenter || [55.6761,12.5683];
  const zoom = current.mapZoom || 13;

  map = L.map("map").setView(center, zoom);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  localPoints = [...(current.points || [])];

  router = L.Routing.control({
    waypoints: localPoints.map(p=>L.latLng(p[0],p[1])),
    routeWhileDragging:true,
    draggableWaypoints:true,
    addWaypoints:false,
    show:false
  }).addTo(map);

  if(localPoints.length === 2){
    setTimeout(()=>router.route(),100);
  }

  map.on("click",e=>{
    if(localPoints.length>=2) return;
    localPoints.push([e.latlng.lat,e.latlng.lng]);
    router.setWaypoints(localPoints.map(p=>L.latLng(p[0],p[1])));
    router.route();
  });

  router.on("routesfound",e=>{
    const d=e.routes[0].summary.totalDistance;
    routeLength.textContent="ğŸ“ LÃ¦ngde: "+(d/1000).toFixed(2)+" km";
  });
}

/* ===== GEM RUTE (FIXET) ===== */
async function saveRoute(){
  if(localPoints.length !== 2){
    alert("SÃ¦t 2 punkter fÃ¸r du kan gemme ruten");
    return;
  }

  const center = map.getCenter();
  const zoom = map.getZoom();

  await db.collection("routes").doc(current.id).update({
    points: localPoints,
    mapCenter: [center.lat, center.lng],
    mapZoom: zoom
  });

  // ğŸ”‘ OPDATER LOKAL STATE
  current.points = [...localPoints];
  current.mapCenter = [center.lat, center.lng];
  current.mapZoom = zoom;

  alert("Ruten er gemt ğŸ‘");
}

/* ===== RUNS ===== */
function addRun(){
  if(!nameInput.value||!timeInput.value) return;
  current.times.push({
    name:nameInput.value,
    time:timeInput.value,
    video:videoInput.value
  });
  db.collection("routes").doc(current.id).update({times:current.times});
  nameInput.value=timeInput.value=videoInput.value="";
}

function renderTimes(){
  times.innerHTML="";
  [...(current.times||[])].sort((a,b)=>toSec(a.time)-toSec(b.time))
    .forEach((t,i)=>{
      const d=document.createElement("div");
      d.className="timeRow";
      d.innerHTML=`
        <b>${i<3?["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]:""} ${t.name}</b> â€“ ${t.time}
        ${t.video?` Â· <a href="${t.video}" target="_blank">ğŸ¥</a>`:""}
      `;
      times.appendChild(d);
    });
}
</script>
</body>
</html>
