<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Time Trials</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:'Orbitron',sans-serif; background:#000; color:#ffb300; overflow-x:hidden; }

/* ORANGE SPEED LINES */
body::before{
  content:"";
  position:fixed;
  inset:-100% -100% -100% -100%;
  background:repeating-linear-gradient(135deg,
    rgba(255,150,0,0.32) 0px,
    rgba(255,150,0,0.32) 16px,
    transparent 16px,
    transparent 320px);
  pointer-events:none;
  z-index:1;
}

/* FLAGS */
.flag{
  position:fixed;
  width:180px;
  height:130px;
  background-size:36px 36px;
  background-image:
    linear-gradient(45deg,#000 25%,transparent 25%),
    linear-gradient(-45deg,#000 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#000 75%),
    linear-gradient(-45deg,transparent 75%,#000 75%);
  background-position:0 0,0 18px,18px -18px,-18px 0px;
  background-color:#fff;
  z-index:1;
}
.flag-left{top:140px;left:40px;transform:rotate(-18deg);}
.flag-right{bottom:40px;right:40px;transform:rotate(12deg);}

#home,.route-page{position:relative;z-index:2;}

button{
  padding:8px 14px;
  background:#111;
  color:#ffb300;
  border:1px solid #ffb300;
  border-radius:6px;
  cursor:pointer;
  transition:transform .15s,box-shadow .15s;
}
button:hover{transform:scale(1.08);box-shadow:0 0 12px rgba(255,180,0,.7);}

.menu-box{
  max-width:420px;
  margin:20px auto;
  background:#111;
  padding:20px;
  border-radius:12px;
  box-shadow:0 0 25px rgba(0,0,0,.7);
  text-align:center;
}

.menu-row{display:flex;gap:10px;justify-content:center;margin-bottom:12px;}

.route-card{
  background:#111;
  padding:15px;
  border-radius:8px;
  width:260px;
  cursor:pointer;
  box-shadow:0 0 15px rgba(0,0,0,.6);
}

.route-page{
  position:fixed;
  inset:0;
  display:none;
  padding:30px;
  z-index:1000;
}

.route-container{
  max-width:900px;
  margin:auto;
  background:#111;
  padding:25px;
  border-radius:12px;
  box-shadow:0 0 30px rgba(0,0,0,.7);
}

table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #333;padding:6px;text-align:center;}
th{background:#222;}
a{color:#ffb300;}

.trash{background:none;border:none;color:red;cursor:pointer;font-size:18px;}

.lb-grid{display:grid;grid-template-columns:1fr 1fr;gap:40px;}
.lb-row{
  display:grid;
  grid-template-columns:40px 1fr auto;
  align-items:center;
  padding:10px;
  margin-bottom:8px;
  background:#111;
  border:1px solid #333;
  border-radius:6px;
}

/* SNAKE */
.game-box{
  width:320px;height:320px;
  margin:20px auto;
  border:2px solid #ffb300;
  display:flex;
  justify-content:center;
  align-items:center;
  box-shadow:0 0 20px rgba(255,180,0,.6);
}
canvas{background:#000;}
</style>
</head>

<body>

<div class="flag flag-left"></div>
<div class="flag flag-right"></div>

<div id="home">
  <h1 style="text-align:center;font-size:60px;">TIME TRIALS</h1>
  <div style="text-align:center;font-size:20px;margin-top:-10px;">
    hvis ikke du ryster, var det ikke hurtigt nok
  </div>

  <div class="menu-box">
    <div class="menu-row">
      <input id="newRouteName" placeholder="Navn p√• rute">
      <button onclick="addRoute()">Tilf√∏j rute</button>
    </div>

    <div class="menu-row">
      <button onclick="openLeaderboard()">üèÜ Leaderboard</button>
      <button onclick="openGames()">üéÆ Games</button>
    </div>
  </div>

  <h2 style="text-align:center;color:red;">RUNS</h2>
  <div id="routes" style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;"></div>
</div>

<div class="route-page" id="routePage"></div>
<div class="route-page" id="leaderboardPage"></div>
<div class="route-page" id="gamesPage"></div>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain: "time-trials-b519e.firebaseapp.com",
  projectId: "time-trials-b519e",
  storageBucket: "time-trials-b519e.firebasestorage.app",
  messagingSenderId: "491396428595",
  appId: "1:491396428595:web:627bc61e5cd1b9475fc446"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let data = { routes:{} };

db.collection("routes").onSnapshot(snapshot=>{
  data.routes={};
  snapshot.forEach(doc=>{
    data.routes[doc.id]=doc.data().runs||[];
  });
  render();
});

// ================= HJ√ÜLP =================
function timeToSeconds(t){
  if(!t)return Infinity;
  const p=t.split(":");
  return parseInt(p[0])*60+parseFloat(p[1]);
}

function medal(i){
  if(i===0)return "ü•á";
  if(i===1)return "ü•à";
  if(i===2)return "ü•â";
  return i+1;
}

// ================= ROUTES =================
async function addRoute(){
  const name=document.getElementById("newRouteName").value.trim();
  if(!name)return;
  await db.collection("routes").doc(name).set({runs:[]});
  document.getElementById("newRouteName").value="";
}

function render(){
  const container=document.getElementById("routes");
  container.innerHTML="";

  for(const route of Object.keys(data.routes)){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    const top3=sorted.slice(0,3);

    let list="";
    top3.forEach((e,i)=>{
      list+=`<div>${medal(i)} ${e.name} ‚Äì ${e.time}</div>`;
    });

    const card=document.createElement("div");
    card.className="route-card";
    card.innerHTML=`<h3>${route}</h3>${list||"Ingen tider endnu"}`;
    card.onclick=()=>openRoute(route);
    container.appendChild(card);
  }
}

function openRoute(route){
  document.getElementById("home").style.display="none";
  const page=document.getElementById("routePage");
  page.style.display="block";

  const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));

  let rows="";
  sorted.forEach((e,i)=>{
    rows+=`
      <tr>
        <td>${medal(i)}</td>
        <td>${e.name}</td>
        <td>${e.car||"-"}</td>
        <td>${e.time}</td>
        <td>${e.video?`<a href="${e.video}" target="_blank">Video</a>`:"-"}</td>
        <td><button class="trash" onclick="deleteEntry('${route}',${i})">üóëÔ∏è</button></td>
      </tr>`;
  });

  page.innerHTML=`
    <div class="route-container">
      <button onclick="closeRoute()">‚Üê Tilbage</button>
      <h2>${route}</h2>

      <input id="name" placeholder="Navn">
      <input id="car" placeholder="Bil">
      <input id="time" placeholder="mm:ss">
      <input id="video" placeholder="Video link">
      <button onclick="addEntry('${route}')">+ Run</button>

      <table>
        <tr><th>Plads</th><th>Navn</th><th>Bil</th><th>Tid</th><th>Video</th><th></th></tr>
        ${rows}
      </table>
    </div>`;
}

function closeRoute(){
  document.getElementById("routePage").style.display="none";
  document.getElementById("home").style.display="block";
}

async function addEntry(route){
  const name=document.getElementById("name").value;
  const car=document.getElementById("car").value;
  const time=document.getElementById("time").value;
  const video=document.getElementById("video").value;
  if(!name||!time)return;

  const runs=data.routes[route];
  runs.push({name,time,car,video});
  await db.collection("routes").doc(route).set({runs});
  openRoute(route);
}

async function deleteEntry(route,index){
  const runs=data.routes[route];
  runs.splice(index,1);
  await db.collection("routes").doc(route).set({runs});
  openRoute(route);
}

// ================= LEADERBOARD =================
function openLeaderboard(){
  document.getElementById("home").style.display="none";
  const page=document.getElementById("leaderboardPage");
  page.style.display="block";

  const stats={};

  for(const route of Object.keys(data.routes)){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    sorted.forEach((run,i)=>{
      if(!stats[run.name])stats[run.name]={runs:0,gold:0,silver:0,bronze:0};
      stats[run.name].runs++;
      if(i===0)stats[run.name].gold++;
      if(i===1)stats[run.name].silver++;
      if(i===2)stats[run.name].bronze++;
    });
  }

  const mostRuns=Object.entries(stats).sort((a,b)=>b[1].runs-a[1].runs);
  const mostMedals=Object.entries(stats).sort((a,b)=>
    (b[1].gold*3+b[1].silver*2+b[1].bronze)-
    (a[1].gold*3+a[1].silver*2+a[1].bronze));

  let col1="",col2="";

  mostRuns.forEach(([n,s],i)=>{
    col1+=`<div class="lb-row"><span>${i+1}</span><span>${n}</span><span>${s.runs}</span></div>`;
  });

  mostMedals.forEach(([n,s],i)=>{
    col2+=`<div class="lb-row"><span>${i+1}</span><span>${n}</span><span>ü•á${s.gold} ü•à${s.silver} ü•â${s.bronze}</span></div>`;
  });

  page.innerHTML=`
    <div class="route-container">
      <button onclick="closeLeaderboard()">‚Üê Tilbage</button>
      <h2>LEADERBOARD</h2>
      <div class="lb-grid">
        <div><h3>üî• Flest runs</h3>${col1||"Ingen data"}</div>
        <div><h3>üèÜ Flest medaljer</h3>${col2||"Ingen data"}</div>
      </div>
    </div>`;
}

function closeLeaderboard(){
  document.getElementById("leaderboardPage").style.display="none";
  document.getElementById("home").style.display="block";
}

// ================= SNAKE =================
let snakeInterval=null;
let snakeKeyHandler=null;

function openGames(){
  document.getElementById("home").style.display="none";
  const page=document.getElementById("gamesPage");
  page.style.display="block";

  page.innerHTML=`
    <div class="route-container">
      <button onclick="closeGames()">‚Üê Tilbage</button>
      <h2 style="text-align:center;">SNAKE</h2>

      <div class="game-box">
        <canvas id="snake" width="300" height="300"></canvas>
      </div>

      <p style="text-align:center;">Brug piletaster ‚Äì Tryk SPACE for at starte</p>
    </div>`;

  startSnake();
}

function closeGames(){
  if(snakeInterval)clearInterval(snakeInterval);
  if(snakeKeyHandler)document.removeEventListener("keydown",snakeKeyHandler);
  document.getElementById("gamesPage").style.display="none";
  document.getElementById("home").style.display="block";
}

function startSnake(){
  const canvas=document.getElementById("snake");
  const ctx=canvas.getContext("2d");
  const box=15;

  let snake=[{x:9*box,y:9*box}];
  let direction="RIGHT";
  let nextDirection="RIGHT";
  let running=false;

  let food={x:5*box,y:5*box};

  snakeKeyHandler=e=>{
    if(e.code==="Space"){running=true;return;}
    if(e.key==="ArrowUp"&&direction!=="DOWN")nextDirection="UP";
    if(e.key==="ArrowDown"&&direction!=="UP")nextDirection="DOWN";
    if(e.key==="ArrowLeft"&&direction!=="RIGHT")nextDirection="LEFT";
    if(e.key==="ArrowRight"&&direction!=="LEFT")nextDirection="RIGHT";
  };

  document.addEventListener("keydown",snakeKeyHandler);

  function draw(){
    ctx.clearRect(0,0,300,300);

    if(!running){
      ctx.fillStyle="#ffb300";
      ctx.font="16px Orbitron";
      ctx.textAlign="center";
      ctx.fillText("Tryk SPACE for at starte",150,150);
      return;
    }

    direction=nextDirection;

    for(let p of snake){
      ctx.fillStyle="#ffb300";
      ctx.fillRect(p.x,p.y,box,box);
    }

    ctx.fillStyle="red";
    ctx.fillRect(food.x,food.y,box,box);

    let head={x:snake[0].x,y:snake[0].y};

    if(direction==="UP")head.y-=box;
    if(direction==="DOWN")head.y+=box;
    if(direction==="LEFT")head.x-=box;
    if(direction==="RIGHT")head.x+=box;

    if(head.x<0||head.y<0||head.x>=300||head.y>=300||
       snake.some(p=>p.x===head.x&&p.y===head.y)){
      snake=[{x:9*box,y:9*box}];
      running=false;
      direction="RIGHT";
      nextDirection="RIGHT";
      return;
    }

    if(head.x===food.x&&head.y===food.y){
      food={x:Math.floor(Math.random()*19)*box,y:Math.floor(Math.random()*19)*box};
    }else{
      snake.pop();
    }

    snake.unshift(head);
  }

  snakeInterval=setInterval(draw,120);
}
</script>

</body>
</html>
