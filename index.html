<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIME TRIALS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#eee}

/* LOGIN */
#login{
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

#login h1{
  color:gold;
  text-align:center;
  margin-bottom:30px;
}

/* üî• SM√Ö HVIDE FIRKANTER */
#login input,
#login button{
  width:260px;
  padding:12px;
  margin-top:12px;
  border-radius:6px;
  border:none;
  font-size:16px;
}

#login input{
  background:#fff;
  color:#000;
}

#login button{
  background:#fff;
  color:#000;
  cursor:pointer;
  font-weight:bold;
}

#login p{
  color:red;
  margin-top:10px;
  display:none;
}

/* APP */
#app{display:none}
header{text-align:center;padding:20px;background:#000}
.title{color:gold;font-size:36px}
.container{padding:15px}
.route{background:#1c1c1c;padding:10px;margin-bottom:10px;border-radius:6px}
#map{height:350px;margin:10px 0;border-radius:8px}
input,button{padding:8px;margin-top:6px}
.timeRow{background:#222;padding:6px;margin-top:6px;border-radius:4px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h1>alle kan k√∏re bil,<br>men det er ikke alle der har rettet</h1>
  <input id="pw" placeholder="Kodeord">
  <button onclick="login()">Log ind</button>
  <p id="err">Forkert kodeord</p>
</div>

<!-- APP -->
<div id="app">
<header>
  <div class="title">TIME TRIALS</div>
  <em>hvis ikke du ryster, var det ikke hurtigt nok</em>
</header>

<div class="container" id="routeList">
  <button onclick="addRoute()">‚ûï Tilf√∏j rute</button>
</div>

<div class="container" id="routePage" style="display:none">
  <button onclick="back()">‚¨Ö Tilbage</button>
  <input id="routeName">
  <div id="routeLength">üìè L√¶ngde: ‚Äì</div>
  <div id="map"></div>

  <h3>Tider</h3>
  <div id="times"></div>

  <input id="nameInput" placeholder="Navn">
  <input id="timeInput" placeholder="Tid (mm:ss)">
  <input id="videoFile" type="file" accept="video/*">
  <button onclick="addTime()">Gem tid (kr√¶ver video)</button>
</div>
</div>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain: "time-trials-b519e.firebaseapp.com",
  projectId: "time-trials-b519e",
  storageBucket: "time-trials-b519e.firebasestorage.app"
});

const db = firebase.firestore();
const storage = firebase.storage();

// LOGIN
function login(){
  if(pw.value === "AK47-DRIFT-TUNE"){
    login.style.display="none";
    app.style.display="block";
  } else {
    err.style.display="block";
  }
}

let routes=[], current=null, map=null, router=null;

// LIVE DATA
db.collection("routes").onSnapshot(snap=>{
  routes=[];
  snap.forEach(d=>routes.push({id:d.id,...d.data()}));
  renderRoutes();
});

function addRoute(){
  db.collection("routes").add({name:"Ny rute",points:[],times:[],distance:0});
}

function renderRoutes(){
  routeList.innerHTML='<button onclick="addRoute()">‚ûï Tilf√∏j rute</button>';
  routes.forEach(r=>{
    const d=document.createElement("div");
    d.className="route";
    d.innerHTML=`<b>${r.name}</b><br>
    üìè ${(r.distance/1000||0).toFixed(2)} km<br>
    <button onclick="openRoute('${r.id}')">√Öbn</button>`;
    routeList.appendChild(d);
  });
}

function openRoute(id){
  current=routes.find(r=>r.id===id);
  routeList.style.display="none";
  routePage.style.display="block";
  routeName.value=current.name;
  routeName.oninput=()=>db.collection("routes").doc(id).update({name:routeName.value});
  renderTimes();
  initMap();
}

function initMap(){
  if(map) map.remove();

  map=L.map("map").setView([55.6761,12.5683],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  router=L.Routing.control({
    waypoints:[],
    routeWhileDragging:true,
    draggableWaypoints:true,
    addWaypoints:false,
    show:false
  }).addTo(map);

  let pts=[];

  map.on("click",e=>{
    if(pts.length>=2) return;
    pts.push([e.latlng.lat,e.latlng.lng]);
    router.setWaypoints(pts.map(p=>L.latLng(p[0],p[1])));
    router.route();
    db.collection("routes").doc(current.id).update({points:pts});
  });

  router.on("routesfound",e=>{
    const d=e.routes[0].summary.totalDistance;
    routeLength.textContent="üìè L√¶ngde: "+(d/1000).toFixed(2)+" km";
    db.collection("routes").doc(current.id).update({distance:d});
  });
}

async function addTime(){
  if(!nameInput.value || !timeInput.value || !videoFile.files[0]){
    alert("Video er p√•kr√¶vet");
    return;
  }

  const file=videoFile.files[0];
  const ref=storage.ref("videos/"+Date.now()+"_"+file.name);
  await ref.put(file);
  const url=await ref.getDownloadURL();

  current.times.push({name:nameInput.value,time:timeInput.value,video:url});
  await db.collection("routes").doc(current.id).update({times:current.times});

  nameInput.value=timeInput.value="";
  videoFile.value="";
}

function renderTimes(){
  times.innerHTML="";
  (current.times||[]).forEach(t=>{
    const d=document.createElement("div");
    d.className="timeRow";
    d.innerHTML=`${t.name} ‚Äì ${t.time} <a href="${t.video}" target="_blank">üé• Se video</a>`;
    times.appendChild(d);
  });
}

function back(){
  routePage.style.display="none";
  routeList.style.display="block";
}
</script>

</body>
</html>
