<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIME TRIALS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#eee}
button{cursor:pointer}
#loginScreen{position:fixed;inset:0;background:black;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000}
#loginScreen h1{color:gold}
#app{display:none}
header{text-align:center;padding:20px;background:#000}
.title{font-size:36px;color:gold}
.container{padding:15px}
.route{background:#1c1c1c;padding:12px;margin-bottom:10px;border-radius:6px}
#map{height:350px;margin:10px 0;border-radius:8px}
.hidden{display:none}
input{width:100%;padding:8px;margin-bottom:6px;border-radius:5px;border:1px solid #333;background:#222;color:#eee}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <h1>TIME TRIALS</h1>
  <input id="pw" placeholder="Kodeord">
  <button onclick="login()">Log ind</button>
</div>

<!-- APP -->
<div id="app">
<header>
  <div class="title">TIME TRIALS</div>
</header>

<div class="container" id="routeList"></div>

<div class="container hidden" id="routePage">
  <button onclick="back()">â¬… Tilbage</button>
  <input id="routeName">
  <div id="map"></div>
  <button onclick="saveRoute()">ðŸ’¾ Gem rute</button>
</div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain:"time-trials-b519e.firebaseapp.com",
  projectId:"time-trials-b519e"
});
const db = firebase.firestore();

/* ================= STATE ================= */
let currentRoute = null;
let map = null;
let router = null;
let currentWaypoints = [];

/* ================= LOGIN ================= */
function login(){
  if(pw.value === "AK47-DRIFT-TUNE"){
    loginScreen.style.display = "none";
    app.style.display = "block";
    loadRoutes();
  }
}

/* ================= LOAD ROUTES ================= */
async function loadRoutes(){
  routeList.innerHTML = '<button onclick="addRoute()">âž• TilfÃ¸j rute</button>';
  const snap = await db.collection("routes").get();

  snap.forEach(doc=>{
    const r = doc.data();
    const div = document.createElement("div");
    div.className = "route";
    div.innerHTML = `
      <b>${r.name || "Ny rute"}</b><br>
      <button onclick="openRoute('${doc.id}')">Ã…bn</button>
    `;
    routeList.appendChild(div);
  });
}

/* ================= ADD ROUTE ================= */
async function addRoute(){
  await db.collection("routes").add({
    name:"Ny rute",
    points:[],
    mapCenter:null,
    mapZoom:null
  });
  loadRoutes();
}

/* ================= OPEN ROUTE ================= */
async function openRoute(id){
  const doc = await db.collection("routes").doc(id).get();
  currentRoute = { id, ...doc.data() };

  routeList.classList.add("hidden");
  routePage.classList.remove("hidden");

  routeName.value = currentRoute.name || "";
  routeName.oninput = () => {
    db.collection("routes").doc(id).update({ name: routeName.value });
  };

  initMap();
}

/* ================= MAP (KORREKT WAYPOINT-LOGIK) ================= */
function initMap(){
  if(map) map.remove();

  const center = currentRoute.mapCenter || [55.6761, 12.5683];
  const zoom = currentRoute.mapZoom || 13;

  map = L.map("map").setView(center, zoom);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  currentWaypoints = [...(currentRoute.points || [])];

  router = L.Routing.control({
    waypoints: currentWaypoints.map(p => L.latLng(p[0], p[1])),
    draggableWaypoints: true,
    addWaypoints: false,
    routeWhileDragging: true,
    show:false
  }).addTo(map);

  // ðŸ”‘ ROUTEREN BESTEMMER DE FAKTISKE WAYPOINTS
  router.on("routesfound", () => {
    currentWaypoints = router.getWaypoints().map(w => [
      w.latLng.lat,
      w.latLng.lng
    ]);
  });

  // Klik kun hvis der mangler punkter
  map.on("click", e => {
    if(currentWaypoints.length >= 2) return;

    currentWaypoints.push([e.latlng.lat, e.latlng.lng]);
    router.setWaypoints(currentWaypoints.map(p => L.latLng(p[0], p[1])));
    router.route();
  });
}

/* ================= SAVE ROUTE (STABIL) ================= */
async function saveRoute(){
  if(currentWaypoints.length !== 2){
    alert("SÃ¦t 2 punkter fÃ¸r du gemmer ruten");
    return;
  }

  const center = map.getCenter();

  await db.collection("routes").doc(currentRoute.id).update({
    points: currentWaypoints,
    mapCenter: [center.lat, center.lng],
    mapZoom: map.getZoom()
  });

  // Lokal sync
  currentRoute.points = [...currentWaypoints];
  currentRoute.mapCenter = [center.lat, center.lng];
  currentRoute.mapZoom = map.getZoom();

  alert("Ruten er gemt korrekt âœ…");
}

/* ================= BACK ================= */
function back(){
  routePage.classList.add("hidden");
  routeList.classList.remove("hidden");
  loadRoutes();
}
</script>
</body>
</html>
