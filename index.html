<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Time Trials</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:'Orbitron',sans-serif; background:#000; color:#ffb300; overflow-x:hidden; }

/* ORANGE SPEED LINES */
body::before{
  content:"";
  position:fixed;
  inset:-100% -100% -100% -100%;
  background:repeating-linear-gradient(135deg,
    rgba(255,150,0,0.32) 0px,
    rgba(255,150,0,0.32) 16px,
    transparent 16px,
    transparent 320px);
  pointer-events:none;
  z-index:1;
}

/* FLAGS */
.flag{
  position:fixed;
  width:180px;
  height:130px;
  background-size:36px 36px;
  background-image:
    linear-gradient(45deg,#000 25%,transparent 25%),
    linear-gradient(-45deg,#000 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#000 75%),
    linear-gradient(-45deg,transparent 75%,#000 75%);
  background-position:0 0,0 18px,18px -18px,-18px 0px;
  background-color:#fff;
  z-index:1;
}
.flag-left{top:140px;left:40px;transform:rotate(-18deg);}
.flag-right{bottom:40px;right:40px;transform:rotate(12deg);}

#home,.route-page{position:relative;z-index:2;}

button{
  padding:8px 14px;
  background:#111;
  color:#ffb300;
  border:1px solid #ffb300;
  border-radius:6px;
  cursor:pointer;
  transition:transform .15s,box-shadow .15s;
}
button:hover{transform:scale(1.08);box-shadow:0 0 12px rgba(255,180,0,.7);}

.menu-box{
  max-width:380px;
  margin:20px auto;
  background:#111;
  padding:20px;
  border-radius:12px;
  box-shadow:0 0 25px rgba(0,0,0,.7);
  text-align:center;
}

.menu-row{display:flex;gap:10px;justify-content:center;margin-bottom:12px;}

.route-card{
  background:#111;
  padding:15px;
  border-radius:8px;
  width:260px;
  cursor:pointer;
  box-shadow:0 0 15px rgba(0,0,0,.6);
}

.route-page{
  position:fixed;
  inset:0;
  display:none;
  padding:30px;
  z-index:1000;
}

.route-container{
  max-width:900px;
  margin:auto;
  background:#111;
  padding:25px;
  border-radius:12px;
  box-shadow:0 0 30px rgba(0,0,0,.7);
}

.lb-grid{display:grid;grid-template-columns:1fr 1fr;gap:40px;}
.lb-row{
  display:grid;
  grid-template-columns:40px 1fr auto;
  align-items:center;
  padding:10px;
  margin-bottom:8px;
  background:#111;
  border:1px solid #333;
  border-radius:6px;
}

table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #333;padding:6px;text-align:center;}
th{background:#222;}
a{color:#ffb300;}
.trash{background:none;border:none;color:red;cursor:pointer;font-size:16px;}
.medal{font-size:20px;}
</style>
</head>

<body>

<div class="flag flag-left"></div>
<div class="flag flag-right"></div>

<div id="home">
  <h1 style="text-align:center;font-size:60px;">TIME TRIALS</h1>

  <!-- MENU -->
  <div class="menu-box">

    <div class="menu-row">
      <input id="newRouteName" placeholder="Navn p√• rute">
      <button onclick="addRoute()">Tilf√∏j rute</button>
    </div>

    <div class="menu-row">
      <button onclick="openLeaderboard()">üèÜ Leaderboard</button>
      <button onclick="openGames()">üéÆ Games</button>
    </div>

  </div>

  <h2 style="text-align:center;color:red;">RUNS</h2>
  <div id="routes" style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;"></div>
</div>

<div class="route-page" id="leaderboardPage"></div>
<div class="route-page" id="routePage"></div>
<div class="route-page" id="gamesPage"></div>

<script>
// ================= FIREBASE =================
const firebaseConfig={
  apiKey:"AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain:"time-trials-b519e.firebaseapp.com",
  projectId:"time-trials-b519e",
  storageBucket:"time-trials-b519e.firebasestorage.app",
  messagingSenderId:"491396428595",
  appId:"1:491396428595:web:627bc61e5cd1b9475fc446"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let data={routes:{}};

db.collection("routes").onSnapshot(snapshot=>{
  data.routes={};
  snapshot.forEach(doc=>{
    data.routes[doc.id]=doc.data().runs||[];
  });
  render();
});

function timeToSeconds(t){
  if(!t)return Infinity;
  const p=t.split(":");
  return parseInt(p[0])*60+parseFloat(p[1]);
}

function medal(i){
  if(i===0)return "ü•á";
  if(i===1)return "ü•à";
  if(i===2)return "ü•â";
  return "";
}

// ================= ROUTES =================
async function addRoute(){
  const name=newRouteName.value.trim();
  if(!name)return;
  await db.collection("routes").doc(name).set({runs:[]});
  newRouteName.value="";
}

function render(){
  const container=document.getElementById("routes");
  container.innerHTML="";

  for(const route of Object.keys(data.routes)){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    const top3=sorted.slice(0,3);

    let list="";
    top3.forEach((e,i)=>{
      list+=`<div><span class="medal">${medal(i)}</span> ${e.name} ‚Äì ${e.time}</div>`;
    });

    const card=document.createElement("div");
    card.className="route-card";
    card.innerHTML=`<h3>${route}</h3>${list||"Ingen tider endnu"}`;
    card.onclick=()=>openRoute(route);
    container.appendChild(card);
  }
}

function openRoute(route){
  home.style.display="none";
  routePage.style.display="block";

  const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));

  let rows="";
  sorted.forEach((e,i)=>{
    rows+=`
      <tr>
        <td>${i+1}</td>
        <td>${e.name}</td>
        <td>${e.car||"-"}</td>
        <td>${e.time}</td>
        <td>${e.video?`<a href="${e.video}" target="_blank">Video</a>`:"-"}</td>
        <td><button class="trash" onclick="deleteEntry('${route}','${e.id}')">üóëÔ∏è</button></td>
      </tr>`;
  });

  routePage.innerHTML=`
    <div class="route-container">
      <button onclick="closeRoute()">‚Üê Tilbage</button>
      <button onclick="deleteRoute('${route}')" style="background:#800;margin-left:10px;">Slet hele ruten</button>
      <h2>${route}</h2>

      <input id="name" placeholder="Navn">
      <input id="car" placeholder="Bil">
      <input id="time" placeholder="mm:ss">
      <input id="video" placeholder="Video link">
      <button onclick="addEntry('${route}')">+ Run</button>

      <table>
        <tr><th>#</th><th>Navn</th><th>Bil</th><th>Tid</th><th>Video</th><th></th></tr>
        ${rows}
      </table>
    </div>`;
}

function closeRoute(){
  routePage.style.display="none";
  home.style.display="block";
}

async function addEntry(route){
  const name=document.getElementById("name").value;
  const car=document.getElementById("car").value;
  const time=document.getElementById("time").value;
  const video=document.getElementById("video").value;
  if(!name||!time)return;

  const runs=data.routes[route];
  runs.push({id:crypto.randomUUID(),name,time,car,video});
  await db.collection("routes").doc(route).set({runs});
  openRoute(route);
}

async function deleteEntry(route,id){
  if(!confirm("Vil du slette dette run?"))return;
  let runs=data.routes[route];
  runs=runs.filter(r=>r.id!==id);
  await db.collection("routes").doc(route).set({runs});
  openRoute(route);
}

// üî• SLET HELE RUTEN
async function deleteRoute(route){
  if(!confirm("Vil du slette HELE ruten?"))return;
  await db.collection("routes").doc(route).delete();
  closeRoute();
}

// ================= LEADERBOARD =================
function openLeaderboard(){
  home.style.display="none";
  leaderboardPage.style.display="block";

  const stats={};

  for(const route of Object.keys(data.routes)){
    const sorted=[...data.routes[route]].sort((a,b)=>timeToSeconds(a.time)-timeToSeconds(b.time));
    sorted.forEach((run,i)=>{
      if(!stats[run.name])stats[run.name]={runs:0,gold:0};
      stats[run.name].runs++;
      if(i===0)stats[run.name].gold++;
    });
  }

  const mostRuns=Object.entries(stats).sort((a,b)=>b[1].runs-a[1].runs);
  const mostGold=Object.entries(stats).sort((a,b)=>b[1].gold-a[1].gold);

  let col1="",col2="";

  mostRuns.forEach(([n,s],i)=>{
    col1+=`<div class="lb-row"><span>${i+1}</span><span>${n}</span><span>${s.runs}</span></div>`;
  });

  mostGold.forEach(([n,s],i)=>{
    col2+=`<div class="lb-row"><span>${i+1}</span><span>${n}</span><span>ü•á ${s.gold}</span></div>`;
  });

  leaderboardPage.innerHTML=`
    <div class="route-container">
      <button onclick="closeLeaderboard()">‚Üê Tilbage</button>
      <h2>LEADERBOARD</h2>
      <div class="lb-grid">
        <div><h3>üî• Flest runs</h3>${col1||"Ingen data"}</div>
        <div><h3>üèÜ Flest medaljer</h3>${col2||"Ingen data"}</div>
      </div>
    </div>`;
}

function closeLeaderboard(){
  leaderboardPage.style.display="none";
  home.style.display="block";
}

// ================= GAMES =================
function openGames(){
  home.style.display="none";
  gamesPage.style.display="block";

  gamesPage.innerHTML=`
    <div class="route-container">
      <button onclick="closeGames()">‚Üê Tilbage</button>
      <h2>SNAKE</h2>
      <canvas id="snake" width="300" height="300"></canvas>
    </div>`;
}

function closeGames(){
  gamesPage.style.display="none";
  home.style.display="block";
}
</script>

</body>
</html>
