<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIME TRIALS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#eee}
#login{position:fixed;inset:0;background:black;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000}
#login h1{color:gold;text-align:center}
#login input,#login button{padding:12px;margin-top:10px}
#app{display:none}
header{text-align:center;padding:20px;background:#000}
.title{color:gold;font-size:36px}
.container{padding:15px}
.route{background:#1c1c1c;padding:10px;margin-bottom:10px;border-radius:6px}
#map{height:350px;margin:10px 0;border-radius:8px}
.btn{padding:8px;width:100%}
</style>
</head>

<body>

<div id="login">
  <h1>alle kan kÃ¸re bil,<br>men det er ikke alle der har rettet</h1>
  <input id="pw" placeholder="Kodeord">
  <button onclick="login()">Log ind</button>
  <p id="err" style="color:red;display:none">Forkert kode</p>
</div>

<div id="app">
<header>
  <div class="title">TIME TRIALS</div>
  <em>hvis ikke du ryster, var det ikke hurtigt nok</em>
</header>

<div class="container" id="routeList">
  <button class="btn" onclick="addRoute()">â• TilfÃ¸j rute</button>
</div>

<div class="container" id="routePage" style="display:none">
  <button onclick="back()">â¬… Tilbage</button>
  <input id="routeName">
  <div id="routeLength">ğŸ“ LÃ¦ngde: â€“</div>
  <div id="map"></div>
</div>
</div>

<script>
// ğŸ”¥ FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyD0Dj_iZYH37GE5ArCidiTgQ5MLb3jatbE",
  authDomain: "time-trials-b519e.firebaseapp.com",
  projectId: "time-trials-b519e",
});
const db = firebase.firestore();

// ğŸ” LOGIN
function login(){
  if(pw.value==="AK47-DRIFT-TUNE"){
    loginDiv.style.display="none";
    app.style.display="block";
  } else err.style.display="block";
}
const loginDiv=document.getElementById("login");
const app=document.getElementById("app");

// ğŸ“¦ DATA
let routes=[], current=null, map=null, router=null;

// ğŸ”„ LIVE DATA
db.collection("routes").onSnapshot(snap=>{
  routes=[];
  snap.forEach(d=>routes.push({id:d.id,...d.data()}));
  renderRoutes();
});

function addRoute(){
  db.collection("routes").add({name:"Ny rute",points:[],distance:0});
}

function renderRoutes(){
  routeList.innerHTML='<button class="btn" onclick="addRoute()">â• TilfÃ¸j rute</button>';
  routes.forEach(r=>{
    const d=document.createElement("div");
    d.className="route";
    d.innerHTML=`<b>${r.name}</b><br>
    ğŸ“ ${(r.distance/1000||0).toFixed(2)} km<br>
    <button onclick="openRoute('${r.id}')">Ã…bn</button>`;
    routeList.appendChild(d);
  });
}

function openRoute(id){
  current=routes.find(r=>r.id===id);
  routeList.style.display="none";
  routePage.style.display="block";
  routeName.value=current.name;
  routeName.oninput=()=>db.collection("routes").doc(id).update({name:routeName.value});
  initMap();
}

function initMap(){
  if(map) map.remove();

  map=L.map("map").setView([55.6761,12.5683],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  router=L.Routing.control({
    waypoints:[],
    routeWhileDragging:true,
    draggableWaypoints:true,
    addWaypoints:false,
    show:false
  }).addTo(map);

  let pts=[];

  map.on("click",e=>{
    if(pts.length>=2) return;
    pts.push([e.latlng.lat,e.latlng.lng]);
    router.setWaypoints(pts.map(p=>L.latLng(p[0],p[1])));
    router.route(); // ğŸ”¥ DET VIGTIGE
    db.collection("routes").doc(current.id).update({points:pts});
  });

  router.on("routesfound",e=>{
    const d=e.routes[0].summary.totalDistance;
    routeLength.textContent="ğŸ“ LÃ¦ngde: "+(d/1000).toFixed(2)+" km";
    db.collection("routes").doc(current.id).update({distance:d});
  });
}

function back(){
  routePage.style.display="none";
  routeList.style.display="block";
}
</script>
</body>
</html>
